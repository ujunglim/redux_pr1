<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.1/redux.js"></script>
  </head>
  <body>
    <div id="title"></div>
    <div id="toc"></div>
    <div id="control"></div>
    <div id="content"></div>

    <script>
      // make modules
      function title() {
        document.querySelector('#title').innerHTML = `
        <header>
          <h1>Hello Web</h1>
        </header>
      `;
      }
      // Table Of Content
      function TOC() {
        let state = store.getState();
        let i = 0;
        let liTags = '';

        while(i < state.contents.length) {
          liTags = liTags + `
            <li>
              <a onclick="
                event.preventDefault();
                let action = {type:'SELECT', id:${state.contents[i].id}};
                store.dispatch(action);
                " 
                href="${state.contents[i].id}">
                ${state.contents[i].title}
              </a>
            </li>
          `
          i++;
        }

        document.querySelector('#toc').innerHTML = `
          <nav>
            <ol>${liTags}</ol>
          </nav>
        `;
      }
      function control() {
        document.querySelector('#control').innerHTML = `
          <input onclick="
            store.dispatch({
              type:'CHANGE_MODE',
              mode:'create'
            })
          " type="button" value="Create">
          
          <input onclick="
            store.dispatch({
              type: 'DELETE'
            })
          " type="button" value="Delete">
        `;
      }

      function content() {
        let state = store.getState();
        let i = 0;
        let aTitle, aDesc;

        if(state.mode === 'create') {
          document.querySelector('#content').innerHTML = `
            <article>
              <form onsubmit="
                event.preventDefault();
                let title = this.title.value;
                let desc = this.desc.value;
                store.dispatch({type: 'CREATE', title, desc})
              ">
                <p>
                  <input type="text" name="title" placeholder="Title">
                </p>
                <p>
                  <textarea name="desc" placeholder="Description"></textarea>  
                </p>
                <input type="submit" >
              </form>
            </article>
          `;
        } 
        else if (state.mode === 'read') {
          while(i < state.contents.length) {
            if(state.contents[i].id === state.selected_id) {
              aTitle = state.contents[i].title;
              aDesc = state.contents[i].desc;
              break;
            }
            i++;
          }
          document.querySelector('#content').innerHTML = `
            <article>
              <h2>${aTitle}</h2>
              ${aDesc}
            </article>
          `;
        }
        else if(state.mode === 'welcome') {
          document.querySelector('#content').innerHTML = `
            <article>
              <h2>Welcome!</h2>
            </article>
          `;
        }
      }
      
      //======================= Redux ===============================
      function reducer(state, action) {
        // set initial state
        if(state === undefined) {
          return {
            max_id: 2,
            mode: 'welcome',  // read, CREATE, welcome
            selected_id: null,
            contents: [
              {id: 1, title: 'HTML', desc: 'HTML is...'},
              {id: 2, title: 'CSS', desc: 'CSS is...'}
            ]
          }
        }
        
        let newState;
        if(action.type === 'SELECT') {
          // copy original state
          newState = Object.assign({}, state, {selected_id: action.id, mode: 'read'});
        }
        else if(action.type === 'CREATE') {
          let newContent = state.contents.concat();
          let newMaxId = state.max_id + 1;

          newContent.push({id: newMaxId, title: action.title, desc: action.desc});
          newState = Object.assign({}, state, {
            max_id: newMaxId,
            mode: 'read',
            contents: newContent
          });
        }
        else if(action.type === 'DELETE') {
          let i = 0;
          const newContents = [];

          while(i < state.contents.length) {
            if(state.contents[i].id !== state.selected_id) {
              newContents.push(state.contents[i]);  // or use filter
            }
            i++;
          }
          newState = Object.assign({}, state, {
            contents: newContents,
            mode: 'welcome'
          })
        }
        else if(action.type === "CHANGE_MODE") {
          newState = Object.assign({}, state, {
            mode: action.mode
          });
        }
        // console.log(action, state, newState)
        return newState;
      }
      const store = Redux.createStore(
          reducer,
          window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__()    
      );
      // when state changes, automatically call func
      store.subscribe(TOC);
      store.subscribe(content);

      title();
      TOC();
      control();
      content();
    </script>
  </body>
</html>